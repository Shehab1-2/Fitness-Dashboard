name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VULTR_SSH_KEY }}

      - name: Deploy to Vultr
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.VULTR_SSH_PORT }} root@${{ secrets.VULTR_IP }} << EOF
            echo "ðŸš€ STEP 1: Starting deploy..."

            echo "ðŸ“ Changing to backend repo..."
            cd ~/backend || exit 1
            git pull origin main || echo 'âš ï¸ Not a Git repo, skipping pull'

            echo "ðŸ“ Moving into Dockerfile directory..."
            cd backend || exit 1
            echo "ðŸ“ Current directory: \$(pwd)"
            echo "ðŸ“‚ Listing files:"
            ls -la

            echo "ðŸ›‘ STEP 2: Cleaning up existing container..."
            docker stop fitness-backend || true
            docker rm fitness-backend || true

            echo "ðŸ³ STEP 3: Building Docker image..."
            docker build -t fitness-dashboard-backend:latest .

            echo "ðŸš€ STEP 4: Running Docker container..."
            docker run -d --env-file .env -p 5001:5001 --name fitness-backend fitness-dashboard-backend:latest

            echo "ðŸ©º STEP 5: Performing health check..."
            sleep 5
            if curl --fail http://localhost:5001/api/hello; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed!"
              echo "ðŸ“„ Dumping container logs:"
              docker logs fitness-backend
              exit 1
            fi
          EOF

      - name: Notify Discord of success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{"username": "Fitness Bot", "content": "âœ… Backend successfully deployed to Vultr ðŸš€"}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord of failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{"username": "Fitness Bot", "content": "âŒ Deployment failed. Check GitHub Actions logs."}' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
